-- DO NOT EDIT THIS FILE DIRECTLY
-- This is a file generated from a literate programing source file located at :TBD:
-- You should make any changes there and regenerate it from Emacs org-mode using C-c C-v t

-- NOTE: This file is inspired by and borrows heavily from https://github.com/zzamboni/dot-hammerspoon/blob/master/init.org

hs.logger.defaultLogLevel = "info"

hyper = {"alt","cmd","ctrl","shift"}
magic = {"alt","cmd","ctrl"}
meh = {"alt", "ctrl", "shift"}

application = hs.application
hotkey = hs.hotkey
grid = hs.grid
window = hs.window
screen = hs.screen
spotify = hs.spotify
machine = hs.host.localizedName()

-- -- https://github.com/fikovnik/ShiftIt/wiki/The-Hammerspoon-Alternative
-- -- https://github.com/derekwyatt/dotfiles/blob/master/hammerspoon-init.lua
-- hs.window.animationDuration = 0
-- units = {
--   right30       = { x = 0.70, y = 0.00, w = 0.30, h = 1.00 },
--   right50       = { x = 0.50, y = 0.00, w = 0.50, h = 1.00 },
--   right70       = { x = 0.30, y = 0.00, w = 0.70, h = 1.00 },
--   left70        = { x = 0.00, y = 0.00, w = 0.70, h = 1.00 },
--   left50        = { x = 0.00, y = 0.00, w = 0.50, h = 1.00 },
--   left30        = { x = 0.00, y = 0.00, w = 0.30, h = 1.00 },
--   top50         = { x = 0.00, y = 0.00, w = 1.00, h = 0.50 },
--   bot50         = { x = 0.00, y = 0.50, w = 1.00, h = 0.50 },
--   upright30     = { x = 0.70, y = 0.00, w = 0.30, h = 0.50 },
--   botright30    = { x = 0.70, y = 0.50, w = 0.30, h = 0.50 },
--   upleft70      = { x = 0.00, y = 0.00, w = 0.70, h = 0.50 },
--   botleft70     = { x = 0.00, y = 0.50, w = 0.70, h = 0.50 },
--   maximum       = { x = 0.00, y = 0.00, w = 1.00, h = 1.00 }
-- }

-- -- hs.hotkey.bind(meh, 'l', function() hs.window.focusedWindow():move(units.right30,    nil, true) end)
-- -- hs.hotkey.bind(meh, 'h', function() hs.window.focusedWindow():move(units.left70,     nil, true) end)
-- hs.hotkey.bind(meh, 'l', function() hs.window.focusedWindow():move(units.right50,    nil, true) end)
-- hs.hotkey.bind(meh, 'h', function() hs.window.focusedWindow():move(units.left50,     nil, true) end)
-- hs.hotkey.bind(meh, 'k', function() hs.window.focusedWindow():move(units.top50,      nil, true) end)
-- hs.hotkey.bind(meh, 'j', function() hs.window.focusedWindow():move(units.bot50,      nil, true) end)
-- hs.hotkey.bind(meh, ']', function() hs.window.focusedWindow():move(units.upright30,  nil, true) end)
-- hs.hotkey.bind(meh, '[', function() hs.window.focusedWindow():move(units.upleft70,   nil, true) end)
-- hs.hotkey.bind(meh, ';', function() hs.window.focusedWindow():move(units.botleft70,  nil, true) end)
-- hs.hotkey.bind(meh, "'", function() hs.window.focusedWindow():move(units.botright30, nil, true) end)
-- hs.hotkey.bind(meh, 'm', function() hs.window.focusedWindow():move(units.maximum,    nil, true) end)

-- -- https://stackoverflow.com/a/58662204
-- hs.hotkey.bind(meh, 'n', function()
--     -- get the focused window
--     local win = hs.window.focusedWindow()
--     -- get the screen where the focused window is displayed, a.k.a. current screen
--     local screen = win:screen()
--     -- compute the unitRect of the focused window relative to the current screen
--     -- and move the window to the next screen setting the same unitRect
--     win:move(win:frame():toUnitRect(screen:frame()), screen:next(), true, 0)
-- end)

hs.loadSpoon("SpoonInstall")

spoon.SpoonInstall.repos.rkspoons = {
  url = "https://github.com/codelahoma/MenuHammer",
  desc = "codelahoma's MenuHammer repo"
}

spoon.SpoonInstall.use_syncinstall = true

Install=spoon.SpoonInstall

hs.loadSpoon("editWithEmacs")
if spoon.editWithEmacs then
  local bindings = {
    edit_selection = {magic, "e"},
    edit_all = {hyper, "e"}
  }
  spoon.editWithEmacs:bindHotkeys(bindings)
end

menuHammer = hs.loadSpoon("MenuHammer")
menuHammer:enter()

Install:andUse("WindowGrid",
                {
                  config = { gridGeometries = { { "8x5", "3840x2160"}, { "6x4" } } },
                  start = true
                }
)

hs.grid.HINTS = {
 {'a', 's', 'd', 'f', '6', '7', '8', '0'}, 
 {'w', 'e', 'r', 't', 'z', 'x', '=', '9'}, 
 {'b', 'g', 'q', 'v', 'y', 'u', 'i', 'o'}, 
 {'1', 'p', '/', 'c', 'n', 'm', '.', '-'}, 
 {'5', '2', '3', '4', 'j', 'k', 'l', ';'}, 
}

Qutebrowser = "org.qt-project.Qt.QtWebEngineCore"
Bitbucket = "com.webcatalog.juli.bitbucket"
Jira = "com.webcatalog.juli.jira"
Chrome = "com.google.Chrome"
Spotify = "com.spotify.client"
Notion = "notion.id"
Zoom = "us.zoom.xos"
Safari = "com.apple.Safari"
Arc = "company.thebrowser.Browser"
Comet = "ai.perplexity.comet"

-- DefaultBrowser = Safari
-- DefaultBrowser = Chrome
-- DefaultBrowser = Comet
DefaultBrowser = Arc

Install:andUse("URLDispatcher",
              {
                config = {
                  decode_slack_redir_urls = true,
                  url_patterns = {
                    { "https?://open.spotify.com", Spotify},
                    -- { "https?://www.notion.so", Notion},
                    -- { "https?://*.zoom.us", Zoom}
                  },
                  default_handler = DefaultBrowser
                },
                start = true,
                loglevel = 'debug'
              }
)

local function setHeadphones()
  hs.audiodevice.findOutputByName("soundcore Space One"):setDefaultOutputDevice()
end

local function setSpeakers()
  hs.audiodevice.findOutputByName("CalDigit USB-C Pro Audio"):setDefaultOutputDevice()
end

hotkey.bind(magic, 'space', spotify.displayCurrentTrack)
hotkey.bind(magic, 'h', setHeadphones)
hotkey.bind(magic, 's', setSpeakers)

Install:andUse("KSheet", {
                 hotkeys = {
                   toggle = { hyper, "-" }
                 }
})

_centeredWindowsFormerPositions = {}
  _appLaunchStats = {}
  _statsFilePath = hs.configdir .. "/app_launch_stats.json"

  -- Load app launch statistics from file
  local function loadAppStats()
     local file = io.open(_statsFilePath, "r")
     if file then
        local content = file:read("*a")
        file:close()
        local success, decoded = pcall(hs.json.decode, content)
        if success and decoded then
           _appLaunchStats = decoded
        end
     end
  end

  -- Save app launch statistics to file
  local function saveAppStats()
     local file = io.open(_statsFilePath, "w")
     if file then
        local encoded = hs.json.encode(_appLaunchStats)
        file:write(encoded)
        file:close()
     end
  end

  -- Track app launch
  local function trackAppLaunch(appName)
     if not _appLaunchStats[appName] then
        _appLaunchStats[appName] = {
           count = 0,
           lastLaunched = nil
        }
     end
     _appLaunchStats[appName].count = _appLaunchStats[appName].count + 1
     _appLaunchStats[appName].lastLaunched = os.time()
     saveAppStats()
  end

  -- Display app launch statistics in graphical window
  _statsWindow = nil

  local function showAppStats()
     -- Convert to sorted array
     local statsArray = {}
     local totalLaunches = 0
     for appName, stats in pairs(_appLaunchStats) do
        table.insert(statsArray, {
           name = appName,
           count = stats.count,
           lastLaunched = stats.lastLaunched
        })
        totalLaunches = totalLaunches + stats.count
     end

     -- Sort by count (descending)
     table.sort(statsArray, function(a, b)
        return a.count > b.count
     end)

     -- Build HTML content
     local html = [[
     <!DOCTYPE html>
     <html>
     <head>
        <style>
           body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
              margin: 0;
              padding: 20px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: #333;
           }
           .container {
              max-width: 700px;
              margin: 0 auto;
              background: white;
              border-radius: 12px;
              box-shadow: 0 10px 40px rgba(0,0,0,0.3);
              overflow: hidden;
           }
           .header {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 25px;
              text-align: center;
           }
           .header h1 {
              margin: 0;
              font-size: 28px;
              font-weight: 600;
           }
           .header .subtitle {
              margin-top: 8px;
              opacity: 0.9;
              font-size: 14px;
           }
           .stats-table {
              padding: 20px;
           }
           table {
              width: 100%;
              border-collapse: collapse;
           }
           th {
              background: #f8f9fa;
              padding: 12px;
              text-align: left;
              font-weight: 600;
              color: #495057;
              border-bottom: 2px solid #dee2e6;
           }
           td {
              padding: 12px;
              border-bottom: 1px solid #e9ecef;
           }
           tr:hover {
              background: #f8f9fa;
           }
           .rank {
              color: #6c757d;
              font-weight: 600;
              width: 50px;
           }
           .app-name {
              font-weight: 500;
              color: #212529;
           }
           .count {
              font-weight: 600;
              color: #667eea;
              text-align: center;
              width: 80px;
           }
           .last-used {
              color: #6c757d;
              font-size: 13px;
              text-align: right;
              width: 150px;
           }
           .empty-state {
              text-align: center;
              padding: 60px 20px;
              color: #6c757d;
           }
           .footer {
              padding: 15px 20px;
              background: #f8f9fa;
              text-align: center;
              color: #6c757d;
              font-size: 13px;
              border-top: 1px solid #dee2e6;
           }
        </style>
     </head>
     <body>
        <div class="container">
           <div class="header">
              <h1>ðŸ“Š App Launch Statistics</h1>
              <div class="subtitle">Total Launches: ]] .. totalLaunches .. [[</div>
           </div>
           <div class="stats-table">
     ]]

     if #statsArray == 0 then
        html = html .. [[
              <div class="empty-state">
                 <h3>No statistics recorded yet</h3>
                 <p>Start using your app launcher shortcuts to see statistics here.</p>
              </div>
        ]]
     else
        html = html .. [[
              <table>
                 <thead>
                    <tr>
                       <th class="rank">#</th>
                       <th class="app-name">Application</th>
                       <th class="count">Launches</th>
                       <th class="last-used">Last Used</th>
                    </tr>
                 </thead>
                 <tbody>
        ]]

        for i, stat in ipairs(statsArray) do
           local lastUsed = "Never"
           if stat.lastLaunched then
              local timeDiff = os.time() - stat.lastLaunched
              if timeDiff < 60 then
                 lastUsed = "Just now"
              elseif timeDiff < 3600 then
                 lastUsed = string.format("%.0f min ago", timeDiff / 60)
              elseif timeDiff < 86400 then
                 lastUsed = string.format("%.0f hours ago", timeDiff / 3600)
              else
                 lastUsed = string.format("%.0f days ago", timeDiff / 86400)
              end
           end

           html = html .. string.format([[
                    <tr>
                       <td class="rank">%d</td>
                       <td class="app-name">%s</td>
                       <td class="count">%d</td>
                       <td class="last-used">%s</td>
                    </tr>
           ]], i, stat.name, stat.count, lastUsed)
        end

        html = html .. [[
                 </tbody>
              </table>
        ]]
     end

     html = html .. [[
           </div>
           <div class="footer">
              Press ESC or click outside to close
           </div>
        </div>
     </body>
     </html>
     ]]

     -- Close existing window if open
     if _statsWindow then
        _statsWindow:delete()
        _statsWindow = nil
     end

     -- Create webview window
     local mainScreen = hs.screen.mainScreen()
     local mainFrame = mainScreen:frame()
     local windowFrame = {
        x = mainFrame.x + (mainFrame.w - 750) / 2,
        y = mainFrame.y + (mainFrame.h - 600) / 2,
        w = 750,
        h = 600
     }

     _statsWindow = hs.webview.new(windowFrame)
        :windowStyle({"titled", "closable", "utility", "HUD"})
        :html(html)
        :allowTextEntry(false)
        :windowTitle("App Launch Statistics")
        :level(hs.drawing.windowLevels.floating)
        :show()

     -- Add ESC key handler to close window
     local escWatcher = hs.eventtap.new({hs.eventtap.event.types.keyDown}, function(event)
        local keyCode = event:getKeyCode()
        if keyCode == 53 then -- ESC key
           if _statsWindow then
              _statsWindow:delete()
              _statsWindow = nil
              if escWatcher then
                 escWatcher:stop()
              end
              return true
           end
        end
        return false
     end)
     escWatcher:start()

     -- Close window when it loses focus (click outside)
     _statsWindow:windowCallback(function(action)
        if action == "focusChange" then
           if _statsWindow then
              _statsWindow:delete()
              _statsWindow = nil
              if escWatcher then
                 escWatcher:stop()
              end
           end
        end
     end)

     _statsWindow:bringToFront()
  end

  local function centerOnMainDisplay()
     local win = window.focusedWindow()
     local formerPosition = _centeredWindowsFormerPositions[win:id()]
     local bigScreen = screen.find('LG HDR 4K')

     hs.console.printStyledtext(hs.inspect(formerPosition))

     if formerPosition then
        win:move(formerPosition)
        _centeredWindowsFormerPositions[win:id()] = nil
     else 
        _centeredWindowsFormerPositions[win:id()] = win:frame()
        win:centerOnScreen()
        if bigScreen then
           win:centerOnScreen(bigScreen)
        else
           win:centerOnScreen()
        end
     end
  end

  local function appLauncher(app)
    return function()
      -- Track the app launch
      trackAppLaunch(app)

      launched = application.launchOrFocus(app)
      if not launched then
        launched = application.launchOrFocusByBundleID(app)
      end

      wonkyAppsThatFocusButReturnFalse = {'Teams', 'iTerm', '/Applications/Emacs.app'}
      for _, v in ipairs(wonkyAppsThatFocusButReturnFalse) do
         if v == app then
            return
         end
      end

      if not launched then
            hs.alert(app .. " not found")
      end
    end
  end

  local function pasteLauncher()
     return function()
        hs.eventtap.keyStroke({"ctrl", "alt", "cmd"}, "p")
     end
  end

  function open750()
    local url = "https://new.750words.com"
    local script = string.format([[
# shows all url+titles of Chrome along with front window+tab url+title
set titleString to ""
set windowFound to false
set tabFound to false

tell application "Google Chrome"
  set window_list to every window # get the windows

  repeat with the_window in window_list # for every window
    set tab_list to every tab in the_window # get the tabs
    set tab_index to 0
    repeat with the_tab in tab_list # for every tab
      set tab_index to tab_index + 1
      set the_title to the title of the_tab
      if the_title contains "V2 - 750 Words" then
        set windowFound to true
        set tabFound to true
        set active tab index of the_window to tab_index
      end if
    end repeat
    if windowFound then exit repeat
  end repeat
  if not tabFound then
    set newTab to make new tab at end of tabs of window 1
    set URL of newTab to "https://new.750words.com"
	
  end if

  activate

end tell


      ]], url, url)

    hs.osascript.applescript(script)
  end

hotkey.bind(hyper, "a", appLauncher('Stickies'))
hotkey.bind(hyper, "b", appLauncher('ChatGPT'))
hotkey.bind(magic, "b", appLauncher('Bazecor'))
hotkey.bind(hyper, "c", hs.toggleConsole)
hotkey.bind(magic, "c", appLauncher('Claude'))
hotkey.bind(hyper, "d", appLauncher('Dash'))
hotkey.bind(magic, "d", appLauncher('Discord'))
hotkey.bind(hyper, "f", appLauncher('DBeaver'))
hotkey.bind(hyper, "i", appLauncher('iTerm'))
hotkey.bind(hyper, "j", appLauncher('Emacs'))
hotkey.bind(hyper, "k", appLauncher('Arc'))
hotkey.bind(magic, "k", appLauncher('Marked'))
hotkey.bind(meh, "k", appLauncher('Google Chrome'))
hotkey.bind(hyper, "l", appLauncher('Fantastical'))
hotkey.bind(hyper, "m", appLauncher('Spark Mail'))
hotkey.bind(hyper, "o", appLauncher('Slack'))
hotkey.bind(hyper, "p", appLauncher('Perplexity'))
hotkey.bind(hyper, "q", appLauncher('1Password'))
hotkey.bind(hyper, "r", hs.reload)
hotkey.bind(hyper, "s", hs.grid.show)
hotkey.bind(magic, "s", appLauncher("Safari"))
hotkey.bind(hyper, "t", appLauncher("DEVONthink 3"))
hotkey.bind(hyper, "u", open750)
hotkey.bind(hyper, "v", pasteLauncher())
hotkey.bind(magic, "z", appLauncher("Zotero"))
hotkey.bind(hyper, ";", appLauncher('Spotify'))
hotkey.bind(hyper, "0", centerOnMainDisplay)
hotkey.bind(magic, "/", showAppStats)

-- menuModal = hs.hotkey.modal.new(hyper, "n")
-- menuModal.alertUID = ""
-- menuModal.alertText = [[
-- Modal Menu
-- ----------
-- a - Activity Monitor
-- b - Brave Browser Dev
-- c - Google Calendar
-- d - Dash
-- m - Mail (removed MailMate)
-- n - Notion
-- p - Postman
-- s - Stickies
-- v - Paste

-- ESC - exit
-- ]]


-- function menuModal:entered()
--    self.alertUID = hs.alert(self.alertText, "forever")
-- end

-- function menuModal:exited()
--  i hs.alert.closeSpecific(self.alertUID)
-- end

-- -- in this example, Ctrl+Shift+h triggers this keybinding mode, which will allow us to use the ones defined below. A nice touch for usability: This also offers to show a message.

-- -- I recommend having this one at all times: Bind the escape key to exit keybinding mode:
-- menuModal:bind("", "escape", " not this time...", nil, function() menuModal:exit() end, nil)

-- -- An example binding I find useful: Type today's date in ISO format.
-- -- menuModal:bind("", "d", "today", nil, function() hs.eventtap.keyStrokes(os.date("%F")) menuModal:exit() end, nil)
-- menuModal:bind("", "a", "activity", nil, function() application.launchOrFocus("Activity Monitor") menuModal:exit() end, nil)
-- menuModal:bind("", "b", "Brave Browser Dev", nil, function() application.launchOrFocus("Brave Browser Dev") menuModal:exit() end, nil)
-- menuModal:bind("", "c", "Google Calendar", nil, function() application.launchOrFocusByBundleID("com.webcatalog.juli.google-calendar") menuModal:exit() end, nil)
-- menuModal:bind("", "d", "dash", nil, function() application.launchOrFocus("Dash") menuModal:exit() end, nil)
-- menuModal:bind("", "m", "Mail", nil, function() application.launchOrFocus("Mail") menuModal:exit() end, nil)
-- menuModal:bind("", "n", "Notion", nil, function() application.launchOrFocus("Notion") menuModal:exit() end, nil)
-- menuModal:bind("", "p", "postman", nil, function() application.launchOrFocus("Postman") menuModal:exit() end, nil)
-- menuModal:bind("", "s", "stickies", nil, function() application.launchOrFocus("Stickies") menuModal:exit() end, nil)
-- menuModal:bind("", "v", "paste", nil, function() hs.eventtap.keyStroke({"cmd", "shift"}, "v") menuModal:exit() end, nil)

caffeine = hs.menubar.new()
hs.caffeinate.set("system", true, false)

local function setCaffeineDisplay(state)
  if state then
    caffeine:setIcon("caffeine-on.pdf")
  else
    caffeine:setIcon("caffeine-off.pdf")
  end
end

local function caffeineClicked()
  setCaffeineDisplay(hs.caffeinate.toggle("system"))
end

if caffeine then
  caffeine:setClickCallback(caffeineClicked)
  setCaffeineDisplay(hs.caffeinate.get("system"))
end

local localfile = hs.configdir .. "/init-local.lua"

if hs.fs.attributes(localfile) then
  dofile(localfile)
end

hs.ipc.cliInstall("/opt/homebrew")

loadAppStats()

hs.alert.show("Config Loaded")
