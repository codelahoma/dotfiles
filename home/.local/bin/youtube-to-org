#!/bin/bash
# youtube-to-org: Capture YouTube video to org inbox
# Usage: youtube-to-org <youtube-url>

set -euo pipefail

URL="${1:-}"

if [[ -z "$URL" ]]; then
    echo "Usage: youtube-to-org <youtube-url>" >&2
    exit 1
fi

# Extract metadata with yt-dlp (no download)
TITLE=$(yt-dlp --get-title "$URL" 2>/dev/null) || {
    echo "Failed to fetch video title" >&2
    exit 1
}

DESC=$(yt-dlp --get-description "$URL" 2>/dev/null | head -20) || DESC=""

# Truncate description to first ~500 chars for abstract
ABSTRACT=$(echo "$DESC" | head -c 500)
[[ ${#DESC} -gt 500 ]] && ABSTRACT="${ABSTRACT}..."

# Escape for elisp
TITLE=$(echo "$TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
ABSTRACT=$(echo "$ABSTRACT" | sed 's/\\/\\\\/g; s/"/\\"/g')
URL=$(echo "$URL" | sed 's/\\/\\\\/g; s/"/\\"/g')

# Add to inbox via emacsclient
/opt/homebrew/bin/emacsclient -e "(with-current-buffer (find-file-noselect \"~/Dropbox/org/gtd/inbox.org\")
  (goto-char (point-max))
  (insert \"\n* TODO [[${URL}][${TITLE}]]\n${ABSTRACT}\n\")
  (save-buffer))" >/dev/null

echo "Captured: $TITLE"
